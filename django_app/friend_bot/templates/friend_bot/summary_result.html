{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–∑—é–º–µ - {{ group.title }}{% endblock %}

{% block extrastyle %}
<style>
    .summary-result {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .summary-content {
        background: white;
        padding: 20px;
        border-radius: 4px;
        border-left: 4px solid #79aec8;
        margin: 20px 0;
        white-space: pre-wrap;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        border: 1px solid #ddd;
        min-height: 200px;
    }
    .stats-box {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
    }
    .back-btn {
        background: #79aec8;
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 4px;
        display: inline-block;
        margin: 10px 0;
    }
    .back-btn:hover {
        background: #417690;
        color: white;
        text-decoration: none;
    }
    .send-to-telegram {
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 10px 10px 10px 0;
    }
    .send-to-telegram:hover {
        background: #218838;
    }
    .edit-hint {
        margin-top: 10px;
        font-size: 12px;
        color: #666;
        background: #fff3cd;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #ffeaa7;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–∑—é–º–µ –≥—Ä—É–ø–ø—ã "{{ group.title }}"</h1>
    
    <div class="stats-box">
        <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</h3>
        <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> {{ start_datetime }} - {{ end_datetime }}</p>
        <p><strong>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong> {{ message_count }}</p>
        <p><strong>–ì—Ä—É–ø–ø–∞:</strong> {{ group.title }} (ID: {{ group.telegram_id }})</p>
    </div>
    
    <div class="summary-result">
        <h3>ü§ñ –†–µ–∑—é–º–µ –æ—Ç AI</h3>
        <div class="summary-content" id="summary-content" contenteditable="true">{{ summary|safe }}</div>
        <div class="edit-hint">
            üí° <strong>–°–æ–≤–µ—Ç:</strong> –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤—ã—à–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Telegram. –ü—Ä–æ—Å—Ç–æ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ç–µ–∫—Å—Ç –∏ –≤–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
        </div>
    </div>
    
    <div class="actions">
        <a href="{% url 'admin:friend_bot_telegramgroup_change' group.id %}" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–µ</a>
        <a href="{% url 'group_summary' group.id %}" class="back-btn">üîÑ –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</a>
        <button class="send-to-telegram" onclick="sendToTelegram()">üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
        <div id="send-status" style="margin-top: 10px;"></div>
    </div>
    
    <!-- CSRF —Ç–æ–∫–µ–Ω –¥–ª—è JavaScript -->
    {% csrf_token %}
</div>

<script>
function sendToTelegram() {
    const button = document.querySelector('.send-to-telegram');
    const statusDiv = document.getElementById('send-status');
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    button.disabled = true;
    button.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...';
    statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—é–º–µ –≤ Telegram...</span>';
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç)
    const chatId = '{{ group.telegram_id }}';
    const messageText = document.getElementById('summary-content').innerHTML;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ API
    fetch('/api/send/message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            chat_id: chatId,
            message_text: messageText,
            auth_token: '{{ auth_token }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'Message sent successfully') {
            statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ –†–µ–∑—é–º–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!</span>';
            button.textContent = 'üì± –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
            button.style.background = '#28a745';
        } else {
            throw new Error(data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message + '</span>';
        button.disabled = false;
        button.textContent = 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram';
    });
}
</script>
{% endblock %}
