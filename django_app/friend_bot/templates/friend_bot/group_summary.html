{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–†–µ–∑—é–º–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ - {{ group.title }}{% endblock %}

{% block extrastyle %}
<style>
    .summary-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input[type="datetime-local"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 250px;
    }
    .quick-select {
        margin-top: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 4px;
    }
    .quick-btn {
        background: #6c757d;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 13px;
    }
    .quick-btn:hover {
        background: #5a6268;
    }
    .submit-btn {
        background: #79aec8;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .submit-btn:hover {
        background: #417690;
    }
    .info-box {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
    }
    .test-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 20px;
        border-radius: 4px;
        margin: 20px 0;
    }
    .test-section h3 {
        color: #856404;
        margin-top: 0;
    }
    .test-btn {
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .test-btn:hover {
        background: #218838;
    }
    .test-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    .prompt-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 20px;
        border-radius: 4px;
        margin: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>üìä –†–µ–∑—é–º–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≥—Ä—É–ø–ø—ã "{{ group.title }}"</h1>
    
    <div class="info-box">
        <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ</h3>
        <p><strong>ID –≤ Telegram:</strong> {{ group.telegram_id }}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {% if group.is_active %}‚úÖ –ê–∫—Ç–∏–≤–Ω–∞{% else %}‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}</p>
        <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ group.useringroup_set.count }}</p>
        <p><strong>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–µ:</strong> {{ group.message_set.count }}</p>
    </div>
    
    <div class="prompt-section">
        <h3>ü§ñ –ü—Ä–æ–º–ø—Ç –¥–ª—è AI</h3>
        <div class="form-group">
            <label for="ai_prompt">–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∑—é–º–µ (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):</label>
            <textarea id="ai_prompt" name="ai_prompt" rows="8" style="width: 100%; font-family: monospace; font-size: 12px;">–¢—ã - –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π —Å–ª–µ–¥–∏–ª –∑–∞ —á–∞—Ç–æ–º –≤ –≥—Ä—É–ø–ø–µ "{{ group.title }}" –∏ —Ç–µ–ø–µ—Ä—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–æ–º—É –¥—Ä—É–≥—É, —á—Ç–æ –æ–Ω –ø—Ä–æ–ø—É—Å—Ç–∏–ª.

–¢–≤–æ–π —Å—Ç–∏–ª—å - —ç—Ç–æ –¥—Ä—É–∂–µ—Å–∫–∞—è –±–µ—Å–µ–¥–∞ –∑–∞ –ø–∏–≤–æ–º, –∂–∏–≤–∞—è, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, —Å —à—É—Ç–∫–∞–º–∏ –∏ –ª–∏—á–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

–°–æ–∑–¥–∞–π –∂–∏–≤–æ–µ —Ä–µ–∑—é–º–µ –≤ HTML-—Ä–∞–∑–º–µ—Ç–∫–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∫–ª—é—á–∞–µ—Ç:
1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –æ–±—Å—É–∂–¥–µ–Ω–∏–π (2-3 –≥–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã —Å —ç–º–æ—Ü–∏—è–º–∏)
2. –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ (—Å –ª–∏—á–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏)
3. –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–ª–∏ —Ü–∏—Ç–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

–ü—Ä–∞–≤–∏–ª–∞ —Å—Ç–∏–ª—è:
- –ù–ï –ù–ê–ß–ò–ù–ê–ô —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è - —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –¥–µ–ª—É
- –û–±—Ä–∞—â–∞–π—Å—è –∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ: "—Ä–µ–±—è—Ç–∫–∏", "–±—Ä–∞—Ç–∏—à–∫–∏", "—Å–µ—Å—Ç—Ä–µ–Ω–∫–∏", "—Ä–µ–±—è—Ç—É—à–∫–∏", "–¥—Ä—É–∑—å—è", "—Ç–æ–≤–∞—Ä–∏—â–∏"
- –ü–∏—à–∏ –∫–∞–∫ –¥—Ä—É–≥ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É: "–±–ª–∏–Ω, –∑–¥–∞—Ä–æ–≤–∞", "—Ç–∞–∫, —Ä–µ–±—è—Ç–∫–∏", "–Ω—É —ç—Ç–æ –Ω–∏–∫—É–¥–∞ –Ω–µ –≥–æ–¥–∏—Ç—Å—è"
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—É—é —Ä–µ—á—å, –º–µ–∂–¥–æ–º–µ—Ç–∏—è, —ç–º–æ—Ü–∏–∏
- –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: "–æ–±—Å—É—Å—Å–∏—Ç–µ—Å—å", "–∑–∞–ø–∞—Å–∞–π—Ç–µ—Å—å –ø–æ–ø–∫–æ—Ä–Ω–æ–º", "–ø–ª–∞—á—É—â–∏–π —Ä–µ–±–µ–Ω–æ–∫ –∏ –Ω–∏–∫–∞–∫–∏—Ö —Å–ø–ª–µ—Ç–µ–Ω??"
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ HTML-—Ç–µ–≥–∏: <b>, <i>, <u>
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–∂–Ω—ã–µ —Ç–µ–≥–∏: <pre>, <ul>, <li>, <code>
- –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Telegram
- –ü—Ä–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –æ–±—Ä–∞—â–∞–π—Å—è —á–µ—Ä–µ–∑ –Ω–∏–∫–∏ (@username)
- –ü—Ä–∏ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∏–º–µ–Ω–∞ (–ò–≤–∞–Ω, –ú–∞—Ä–∏—è)
- –¶–∏—Ñ—Ä—ã —É–ø–æ–º–∏–Ω–∞–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –≤—ã–¥–∞—é—â–∏–µ—Å—è/–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ
- –ë–ï–ó –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ –∏ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ - –ø–∏—à–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ
- –î–æ–±–∞–≤–ª—è–π <tg-spoiler></tg-spoiler> –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–≥–¥–∞ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –æ —Ç–µ–º–∞—Ö –∏–ª–∏ —Ü–∏—Ç–∞—Ç–∞—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º —Ç–µ–ª–µ–≥—Ä–∞–º–º–Ω–æ–º, —Å—Å—ã–ª–∫–∏ –æ—Ñ–æ—Ä–º–ª—è–π —Ç–µ–≥–æ–º <a href="https://t.me/c/{chat_id_clean}/{msg.telegram_id}">—Å—Å—ã–ª–∫–∞</a>

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 3500 —Å–∏–º–≤–æ–ª–æ–≤ (–¥–ª—è Telegram)
- –ò–∑–±–µ–≥–∞–π –¥–ª–∏–Ω–Ω—ã—Ö –∞–±–∑–∞—Ü–µ–≤ - —Ä–∞–∑–±–∏–≤–∞–π –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ
- –ë–µ–∑ –ª–∏—à–Ω–∏—Ö HTML-—Ç–µ–≥–æ–≤ - —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ
- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫</textarea>
        </div>
    </div>
    
    <div class="summary-form">
        <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" id="custom_prompt" name="custom_prompt">
            <div class="form-group">
                <label for="start_datetime">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞:</label>
                <input type="datetime-local" id="start_datetime" name="start_datetime" required>
            </div>
            <div class="form-group">
                <label for="end_datetime">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞:</label>
                <input type="datetime-local" id="end_datetime" name="end_datetime" required>
            </div>
            <button type="submit" class="submit-btn" onclick="updateCustomPrompt()">üöÄ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑—é–º–µ</button>
        </form>
        
        <div class="quick-select">
            <h4>‚ö° –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:</h4>
            <button type="button" onclick="setLastDay()" class="quick-btn">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏</button>
            <button type="button" onclick="setLastWeek()" class="quick-btn">–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è</button>
            <button type="button" onclick="setLastMonth()" class="quick-btn">–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</button>
        </div>
    </div>
    
    <!-- –¢–µ—Å—Ç–æ–≤–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="test-section">
        <h3>üß™ –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram</h3>
        <div class="form-group">
            <label for="test_message">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:</label>
            <textarea id="test_message" name="test_message" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...">–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Django –∞–¥–º–∏–Ω–∫–∏.</textarea>
        </div>
        <button type="button" onclick="sendTestMessage()" class="test-btn">üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –≤ Telegram</button>
        <div id="test-status" style="margin-top: 10px;"></div>
    </div>
    
    <div class="info-box">
        <h3>üí° –ß—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:</h3>
        <ul>
            <li>–û–±—â–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≥—Ä—É–ø–ø—ã</li>
            <li>–°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</li>
            <li>–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –æ–±—Å—É–∂–¥–µ–Ω–∏–π</li>
            <li>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é</li>
            <li>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π</li>
        </ul>
    </div>
</div>

<script>
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏)
document.addEventListener('DOMContentLoaded', function() {
    setLastDay();
});

function setLastDay() {
    const now = new Date();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    document.getElementById('end_datetime').value = formatDateTime(now);
    document.getElementById('start_datetime').value = formatDateTime(yesterday);
}

function setLastWeek() {
    const now = new Date();
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('end_datetime').value = formatDateTime(now);
    document.getElementById('start_datetime').value = formatDateTime(weekAgo);
}

function setLastMonth() {
    const now = new Date();
    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    
    document.getElementById('end_datetime').value = formatDateTime(now);
    document.getElementById('start_datetime').value = formatDateTime(monthAgo);
}

function formatDateTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function updateCustomPrompt() {
    const promptText = document.getElementById('ai_prompt').value;
    document.getElementById('custom_prompt').value = promptText;
}

function sendTestMessage() {
    const button = document.querySelector('.test-btn');
    const statusDiv = document.getElementById('test-status');
    const messageText = document.getElementById('test_message').value;
    
    if (!messageText.trim()) {
        statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!</span>';
        return;
    }
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    button.disabled = true;
    button.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...';
    statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram...</span>';
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const chatId = '{{ group.telegram_id }}';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ API
    fetch('/api/send/message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            chat_id: chatId,
            message_text: messageText,
            auth_token: '{{ auth_token }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'Message sent successfully') {
            statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!</span>';
            button.textContent = 'üì± –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
            button.style.background = '#28a745';
        } else {
            throw new Error(data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message + '</span>';
        button.disabled = false;
        button.textContent = 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –≤ Telegram';
    });
}
</script>
{% endblock %}
